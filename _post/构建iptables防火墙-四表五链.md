---
日期: 2025年2月1日
---

在使用 Linux 防火墙之前，先简单了解下 iptables，iptables 是 Linux 内置的包过滤控制工具，通俗点来说就是防火墙，但是真正实现防火墙核心功能的是 Linux 内核空间中的网络数据包过滤框架 netfilter, 而 iptables 属于用户空间中用来控制 netfilter 的命令行控制工具，为了方便后续内容的理解，统一将 iptables 理解为 Linux 防火墙即可.

> 如果掌握了iptables，也就掌握了基本的互联网技术，甚至能够部署并管理企业网络防火墙

# iptables 四表五链

iptables 的功能比较神奇的，它是通过 表(Table) 和 链(Chain) 来控制流经内核的网络数据包的，先理解下 表(Table) 和 链(Chain) 

链(Chain) 是 iptables 具体规则功能的标识节点，这些节点控制网络栈中的数据流，具体有 5 个链： 
 - PREROUTING：主机外的数据包要进入防火墙时，所有的数据包在到达路由决策之前首先由 PREROUTING 链进行处理。该链主要用于目标地址转换（DNAT）
 - INPUT：从外界进入防火墙的数据包会应用此规则链中的策略。也就是说，如果数据包的目的地址是防火墙本身，那么数据包经过路由决策后，就会到达 INPUT 链。INPUT 链主要处理进入本机的数据包。
 - FORWARD：转发数据包时会应用此规则链中的策略。当数据包经过路由决策后，如果数据包的目的地址不是本机，也不是由本机发出，那么数据包就会经过 FORWARD 链转发。FORWARD 链主要处理流经本机的数据包。
 - OUTPUT：从防火墙本机外出的数据表会应用此规则链中的策略。也就是说，本机向外发送的数据包首先会经过 OUTPUT 链处理。OUTPUT 链主要处理本机发出的数据包。
 - POSTROUTING：主机内的报文要从防火墙出去时，需要经过 POSTROUTING 链进行处理。该链主要用于源地址转换（SNAT）。所有的数据包在离开防火墙之前，都会经过 POSTROUTING 链。
 
表(Table) 用于区分不同 链(Chain) 功能的规则并存储这些规则，具体有 4 张表：
 - raw :用于监视流量处理异常，对应硬件防火墙的**流量审计**功能
 - mangle：用于流量整形，处理数据包，对应硬件防火墙的**QOS**、**策略路由**功能
 - nat : 用于地址转换，对应硬件防火墙的**地址转换**功能
 - filter: 用于包过滤，对应硬件防火墙的**ACL 访问控制**功能
          	 		 

![Image](https://github.com/user-attachments/assets/cd3ce7d8-3b5c-41bf-8acf-212ae0d261bb)

 
说明：  
- 数据包首先进入PREROUTING链（路由前处理）。  
- 然后根据路由决策，数据包可能进入ROUTING链（路由决策）。  
- 如果数据包需要被转发，它会进入FORWARD链。  
- 数据包离开系统前会经过POSTROUTING链（路由后处理）。  
- 如果数据包是到达本地系统的，它会进入INPUT链。  
- 如果数据包是由本地系统产生的，它会进入OUTPUT链。  
- 在每个链中，数据包会与规则进行匹配，并执行相应的动作（ACCEPT, DROP, REJECT, 等）。  
- 如果数据包在链中没有与任何规则匹配，它会根据链的默认策略进行处理。  
  
注意：此流程图省略了iptables的四个表（raw, mangle, nat, filter）的细节，因为这四个表主要影响的是链中规则的具体内容和行为，而不是数据包的基本处理流程。

# iptables 规则优先级

在iptables中，规则的优先级决定了哪些规则会被优先匹配和执行，这对于网络流量的控制至关重要。iptables规则的优先级主要体现在以下几个方面：

规则匹配顺序：
 - 和所有防火墙系统一样，iptables 按照规则添加的顺序进行匹配，先添加的规则会优先匹配，一旦匹配成功，就会停止后续规则的匹配。因此，在添加规则时需要注意顺序，确保重要规则在最前面。
- 表的优先级：
 - 如之前所述，iptables内置了4个表，分别是filter表、nat表、mangle表和raw表。这4个表的优先级顺序是 `raw > mangle > nat > filter`。
